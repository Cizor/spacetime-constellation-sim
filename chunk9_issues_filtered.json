[
  {
    "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/165",
    "repository_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim",
    "labels_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/165/labels{/name}",
    "comments_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/165/comments",
    "events_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/165/events",
    "html_url": "https://github.com/Cizor/spacetime-constellation-sim/issues/165",
    "id": 3712243993,
    "node_id": "I_kwDOQfMfks7dRFkZ",
    "number": 165,
    "title": "[Scope 4][Chunk 9] Epic – Wire scheduler, agents & telemetry into scenario lifecycle",
    "user": {
      "login": "Cizor",
      "id": 11782718,
      "node_id": "MDQ6VXNlcjExNzgyNzE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/11782718?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Cizor",
      "html_url": "https://github.com/Cizor",
      "followers_url": "https://api.github.com/users/Cizor/followers",
      "following_url": "https://api.github.com/users/Cizor/following{/other_user}",
      "gists_url": "https://api.github.com/users/Cizor/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Cizor/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Cizor/subscriptions",
      "organizations_url": "https://api.github.com/users/Cizor/orgs",
      "repos_url": "https://api.github.com/users/Cizor/repos",
      "events_url": "https://api.github.com/users/Cizor/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Cizor/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "labels": [
      {
        "id": 9738572054,
        "node_id": "LA_kwDOQfMfks8AAAACRHbRFg",
        "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/labels/type:tracking",
        "name": "type:tracking",
        "color": "4eaa16",
        "default": false,
        "description": ""
      },
      {
        "id": 9782134341,
        "node_id": "LA_kwDOQfMfks8AAAACRw-GRQ",
        "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/labels/scope:4-sbi",
        "name": "scope:4-sbi",
        "color": "5a2e28",
        "default": false,
        "description": ""
      },
      {
        "id": 9782140626,
        "node_id": "LA_kwDOQfMfks8AAAACRw-e0g",
        "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/labels/chunk:9-sbi-integration",
        "name": "chunk:9-sbi-integration",
        "color": "b9eda4",
        "default": false,
        "description": ""
      }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
      "login": "Cizor",
      "id": 11782718,
      "node_id": "MDQ6VXNlcjExNzgyNzE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/11782718?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Cizor",
      "html_url": "https://github.com/Cizor",
      "followers_url": "https://api.github.com/users/Cizor/followers",
      "following_url": "https://api.github.com/users/Cizor/following{/other_user}",
      "gists_url": "https://api.github.com/users/Cizor/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Cizor/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Cizor/subscriptions",
      "organizations_url": "https://api.github.com/users/Cizor/orgs",
      "repos_url": "https://api.github.com/users/Cizor/repos",
      "events_url": "https://api.github.com/users/Cizor/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Cizor/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "assignees": [
      {
        "login": "Cizor",
        "id": 11782718,
        "node_id": "MDQ6VXNlcjExNzgyNzE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/11782718?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Cizor",
        "html_url": "https://github.com/Cizor",
        "followers_url": "https://api.github.com/users/Cizor/followers",
        "following_url": "https://api.github.com/users/Cizor/following{/other_user}",
        "gists_url": "https://api.github.com/users/Cizor/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/Cizor/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Cizor/subscriptions",
        "organizations_url": "https://api.github.com/users/Cizor/orgs",
        "repos_url": "https://api.github.com/users/Cizor/repos",
        "events_url": "https://api.github.com/users/Cizor/events{/privacy}",
        "received_events_url": "https://api.github.com/users/Cizor/received_events",
        "type": "User",
        "user_view_type": "public",
        "site_admin": false
      }
    ],
    "milestone": {
      "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/milestones/4",
      "html_url": "https://github.com/Cizor/spacetime-constellation-sim/milestone/4",
      "labels_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/milestones/4/labels",
      "id": 14244293,
      "node_id": "MI_kwDOQfMfks4A2VnF",
      "number": 4,
      "title": "Scope 4 – Planning & Scheduling",
      "description": "",
      "creator": {
        "login": "Cizor",
        "id": 11782718,
        "node_id": "MDQ6VXNlcjExNzgyNzE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/11782718?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Cizor",
        "html_url": "https://github.com/Cizor",
        "followers_url": "https://api.github.com/users/Cizor/followers",
        "following_url": "https://api.github.com/users/Cizor/following{/other_user}",
        "gists_url": "https://api.github.com/users/Cizor/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/Cizor/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Cizor/subscriptions",
        "organizations_url": "https://api.github.com/users/Cizor/orgs",
        "repos_url": "https://api.github.com/users/Cizor/repos",
        "events_url": "https://api.github.com/users/Cizor/events{/privacy}",
        "received_events_url": "https://api.github.com/users/Cizor/received_events",
        "type": "User",
        "user_view_type": "public",
        "site_admin": false
      },
      "open_issues": 73,
      "closed_issues": 0,
      "state": "open",
      "created_at": "2025-11-29T09:54:27Z",
      "updated_at": "2025-12-10T17:09:37Z",
      "due_on": null,
      "closed_at": null
    },
    "comments": 0,
    "created_at": "2025-12-09T18:57:02Z",
    "updated_at": "2025-12-09T18:57:02Z",
    "closed_at": null,
    "author_association": "OWNER",
    "active_lock_reason": null,
    "sub_issues_summary": {
      "total": 2,
      "completed": 0,
      "percent_completed": 0
    },
    "issue_dependencies_summary": {
      "blocked_by": 0,
      "total_blocked_by": 0,
      "blocking": 0,
      "total_blocking": 0
    },
    "body": "## Background\n\nBy the end of **Chunk 8**, you have the core SBI mechanisms in place:\n\n- **CDPI (scheduling) path:**\n  - A `CDPIServer` that:\n    - Accepts agent `ReceiveRequests` streams (Hello/Reset/Response).\n    - Tracks per-agent handles and outgoing scheduling messages.\n  - A per-node `Agent` that:\n    - Maintains a local schedule of `ScheduledAction`s.\n    - Uses `EventScheduler` to execute actions at the right sim time.\n    - Applies beams/routes into `ScenarioState`.\n- **Scheduler logic (controller side):**\n  - A `Scheduler` component that:\n    - Inspects `ScenarioState` and potential links.\n    - Emits `ScheduledAction`s via `CDPIServer.SendCreateEntry` / `SendDeleteEntry`.\n    - (Optionally) uses `ServiceRequest`s to schedule minimal connectivity.\n- **Telemetry path:**\n  - `TelemetryState` and `TelemetryServer` implementing `ExportMetrics`.\n  - Agents with a telemetry loop:\n    - Derive per-interface metrics via `deriveInterfaceState` and `ScenarioState`.\n    - Periodically call `TelemetryService.ExportMetrics` using **sim time**.\n\nWhat’s still missing is **full integration** into the normal **scenario lifecycle**:\n\n- When a scenario is created/loaded via NBI, SBI components should spin up automatically.\n- When the sim clock advances, **EventScheduler** callbacks should run.\n- Agents and scheduler should start and stop with the scenario.\n- Telemetry and CDPI services should be registered on the in-process gRPC server used by the simulator.\n\nThis epic wires all of that together so SBI becomes a **first-class part of a normal run**, not just a set of isolated components.\n\n## Goal\n\nProvide an integrated, production-ready SBI wiring so that:\n\n- When a scenario is loaded:\n  - `ScenarioState` is constructed.\n  - CDPI, telemetry, scheduler, and per-node agents are created and started.\n- During the simulation run:\n  - The sim clock advances.\n  - `EventScheduler` runs due events.\n  - Agents execute scheduled actions and emit telemetry.\n- On shutdown:\n  - Agents and scheduler are cleanly stopped.\n- A small set of config flags controls SBI enablement and telemetry interval.\n\nAt the end of this epic, **running the simulator with SBI enabled** should “just work” without additional ad-hoc wiring.\n\n## Where to look\n\nScenario and sim lifecycle:\n\n- The code that currently coordinates a run, e.g.:\n  - `cmd/simulator/main.go` (or similar).\n  - A `runner`/`engine` package under `sim/` or `internal/sim/...`.\n- The place where:\n  - `ScenarioState` is constructed from NBI/inputs.\n  - The time controller / sim clock is created and advanced.\n\nSBI components (from previous chunks):\n\n- CDPI server:\n  - `internal/sbi/controller/cdpi_server.go` (or equivalent).\n- Scheduler:\n  - `internal/sbi/controller/scheduler.go`.\n- Agent:\n  - `internal/sbi/agent/agent.go`.\n- Telemetry:\n  - `internal/sbi/telemetry_server.go` and `TelemetryState`.\n\nTime and scheduling:\n\n- Sim clock / time controller (Scope 1–2):\n  - `timectrl` or equivalent package.\n- Event scheduler:\n  - `internal/sbi/event_scheduler.go` and `FakeEventScheduler` in tests.\n\ngRPC server:\n\n- Wherever the **NBI** server is registered:\n  - Typically `internal/nbi/server.go` and gRPC bootstrap code.\n- You will register:\n  - `ControlDataPlaneInterfaceServer`.\n  - `TelemetryServiceServer` alongside NBI services.\n\nSearch terms:\n\n- `ScenarioState` construction\n- `RunScenario`, `StartSimulation`, or similar\n- `grpc.NewServer`\n- `EventScheduler` implementation\n- `Agent struct`, `CDPIServer`, `TelemetryServer`\n\n## Tasks\n\n### 1. Introduce an SBI runtime/options struct\n\nDefine a small struct to hold SBI runtime dependencies and configuration, e.g.:\n\n- Location: `internal/sbi/runtime.go` or a similar integration-focused file.\n\n  type SBIRuntimeOptions struct {\n      EnableSBI         bool\n      TelemetryInterval time.Duration\n  }\n\n  type SBIRuntime struct {\n      State      *simstate.ScenarioState\n      Clock      sbi.EventScheduler\n      Telemetry  *TelemetryState\n      TelemetryS *TelemetryServer\n      CDPI       *CDPIServer\n      Scheduler  *Scheduler\n      Agents     map[string]*agent.Agent\n\n      opts SBIRuntimeOptions\n  }\n\nResponsibilities:\n\n- Encapsulate:\n  - Creation of telemetry/CDPI/scheduler/agents.\n  - Registration of SBI servers on the gRPC server.\n  - Start/stop lifecycle for agents and scheduler.\n- Keep sim runner code cleaner by delegating SBI details to `SBIRuntime`.\n\n### 2. Wire SBI into scenario startup\n\nIn the main scenario startup path (e.g. `RunScenario` or equivalent):\n\n1. After `ScenarioState` is constructed and the sim clock is prepared:\n\n   - Construct an `EventScheduler` instance bound to the sim clock:\n     \n         scheduler := sbi.NewEventScheduler(clock)\n\n2. Build the `TelemetryState` and `TelemetryServer`:\n\n   - Example:\n\n         telemetryState := NewTelemetryState()\n         telemetryServer := &TelemetryServer{\n             Telemetry: telemetryState,\n         }\n\n3. Build the `CDPIServer`:\n\n   - Example:\n\n         cdpi := &CDPIServer{\n             State:  scenarioState,\n             Clock:  scheduler,\n             // other fields, maps, etc., per previous chunks\n         }\n\n4. Build the `Scheduler`:\n\n         sched := &Scheduler{\n             State: scenarioState,\n             Clock: scheduler,\n             CDPI:  cdpi,\n         }\n\n5. Create an `SBIRuntime`:\n\n         sbiRuntime := &SBIRuntime{\n             State:      scenarioState,\n             Clock:      scheduler,\n             Telemetry:  telemetryState,\n             TelemetryS: telemetryServer,\n             CDPI:       cdpi,\n             Scheduler:  sched,\n             Agents:     make(map[string]*agent.Agent),\n             opts: SBIRuntimeOptions{\n                 EnableSBI:         true,              // driven by flags/config\n                 TelemetryInterval: time.Second,       // default; overridable\n             },\n         }\n\n6. For each node that should have an agent:\n\n   - Iterate over nodes in `ScenarioState` (e.g. satellites, ground stations).\n   - Construct an `Agent`:\n\n         ag := &agent.Agent{\n             AgentID:          nodeCfg.AgentID, // or derived\n             NodeID:           node.ID,\n             State:            scenarioState,\n             Scheduler:        scheduler,\n             TelemetryClient:  telemetryClientStub, // in-process gRPC client\n             TelemetryInterval: sbiRuntime.opts.TelemetryInterval,\n             // CDPI stream/client wiring handled in Chunk 9 sub-issues\n         }\n\n   - Store in `sbiRuntime.Agents[node.ID] = ag`.\n\n7. Expose a helper on `SBIRuntime`:\n\n   - `func (r *SBIRuntime) Start(ctx context.Context) error`\n   - `func (r *SBIRuntime) Stop()`\n\n   Where `Start`:\n\n   - Registers gRPC servers.\n   - Starts agents (their CDPI streams and telemetry loops).\n   - Optionally kicks the controller `Scheduler` into computing initial schedule.\n\n### 3. Register SBI services on the gRPC server\n\nUpdate the gRPC bootstrap (same place where NBI is registered):\n\n- Once the `grpc.Server` is created:\n\n      grpcServer := grpc.NewServer()\n      // Existing NBI registrations...\n      telemetry.RegisterTelemetryServiceServer(grpcServer, sbiRuntime.TelemetryS)\n      scheduling.RegisterControlDataPlaneInterfaceServer(grpcServer, sbiRuntime.CDPI)\n\nDesign notes:\n\n- For now, SBI and NBI can share the same gRPC server and port.\n- If you already have a listener for NBI, reuse it.\n- Ensure SBI services are ready before agents/clients try to connect.\n\n### 4. Integrate EventScheduler into the main sim loop\n\nEnsure the sim loop drives the `EventScheduler`:\n\n- In the main run loop, where sim time is advanced:\n\n  1. Advance sim clock (existing mechanism):\n\n         clock.AdvanceTo(nextTime) // or equivalent\n\n  2. Run due events in `EventScheduler`:\n\n         scheduler.RunDue()\n\nDesign notes:\n\n- If your `EventScheduler` already listens to the clock internally, make sure the main loop calls a `RunDue()` or equivalent method.\n- The goal is: whenever sim time jumps forward, all scheduled SBI events with `When <= Now()` are executed.\n\n### 5. Add configuration flags / options\n\nIn your CLI or configuration system:\n\n- Add flags such as:\n\n  - `--enable-sbi` (default `true` once stable).\n  - `--telemetry-interval=1s` (sim time).\n\n- Thread them through:\n\n  - From CLI → main → `SBIRuntimeOptions`.\n\nExample:\n\n- If `--enable-sbi=false`:\n\n  - Skip creation/registration of all SBI components.\n  - `SBIRuntime` can be `nil` or a no-op.\n\n- If telemetry interval is provided:\n\n  - Override `TelemetryInterval` for agents.\n\n### 6. Minimal integration tests / smoke tests\n\nAdd a small integration-oriented test (does not need full end-to-end Scope 11 coverage yet):\n\n- New test file, e.g.:\n\n  - `cmd/simulator/sbi_integration_smoke_test.go` or\n  - `internal/sim/sbi_integration_test.go`.\n\nTest ideas:\n\n1. **Scenario with one node and no links:**\n\n   - Start simulator with SBI enabled.\n   - Assert:\n     - `SBIRuntime` is created.\n     - One agent exists for the node.\n     - gRPC server registers both CDPI and Telemetry services (can introspect via reflection or test harness).\n\n2. **Scenario with one potential link:**\n\n   - Ensure scheduler creates at least one `ScheduledAction`.\n   - Advance clock and run scheduler/events.\n   - Assert:\n     - `ScenarioState` shows link becoming active at the expected time.\n\n3. **Telemetry sanity check:**\n\n   - Run sim for a short time with telemetry enabled.\n   - Assert:\n     - `TelemetryState` contains entries for the node/interface.\n\nTests can be relatively coarse, focusing on **wiring correctness** rather than algorithmic detail.\n\n## Acceptance criteria\n\n- **SBI runtime encapsulation:**\n  - `SBIRuntimeOptions` and `SBIRuntime` (or equivalent) exist and encapsulate:\n    - `ScenarioState`, `EventScheduler`, `TelemetryState`, `TelemetryServer`, `CDPIServer`, `Scheduler`, and agents.\n  - `SBIRuntime.Start/Stop` manages SBI component lifecycle.\n\n- **Scenario startup integration:**\n  - When a scenario is loaded:\n    - `EventScheduler` is constructed and bound to sim clock.\n    - `TelemetryState` and `TelemetryServer` are created.\n    - `CDPIServer` and `Scheduler` are created.\n    - Agents are created for all relevant nodes and stored in `SBIRuntime`.\n    - If `EnableSBI` is `true`, `SBIRuntime.Start` is invoked.\n\n- **gRPC wiring:**\n  - `TelemetryServiceServer` and `ControlDataPlaneInterfaceServer` are both registered on the simulator’s gRPC server.\n  - Agents can reach CDPI/Telemetry services in-process during normal runs.\n\n- **EventScheduler integration:**\n  - Main sim loop calls `scheduler.RunDue()` (or equivalent) after advancing sim time, ensuring SBI events execute at the correct simulated times.\n\n- **Configuration:**\n  - Command-line flags or config options exist for:\n    - Enabling/disabling SBI (`--enable-sbi`).\n    - Telemetry interval (`--telemetry-interval`).\n  - When SBI is disabled:\n    - Simulator runs without creating or registering SBI components.\n    - No agent or scheduler routines are started.\n\n- **Smoke tests:**\n  - At least one integration-style test validates:\n    - SBI components are constructed and registered for a simple scenario.\n    - The scheduler can cause at least one scheduled action to be executed when time advances.\n    - Telemetry is stored in `TelemetryState` for a simple case.\n  - All new tests pass via `go test ./...`.\n\n- **Repository health:**\n  - `go build ./...` passes with SBI wiring enabled.\n  - `go test ./...` passes, including new integration/smoke tests.\n",
    "closed_by": null,
    "reactions": {
      "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/165/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/165/timeline",
    "performed_via_github_app": null,
    "state_reason": null
  },
  {
    "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/167",
    "repository_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim",
    "labels_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/167/labels{/name}",
    "comments_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/167/comments",
    "events_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/167/events",
    "html_url": "https://github.com/Cizor/spacetime-constellation-sim/issues/167",
    "id": 3712327838,
    "node_id": "I_kwDOQfMfks7dRaCe",
    "number": 167,
    "title": "[Scope 4][Chunk 9] Wire SBI components into simulator scenario startup",
    "user": {
      "login": "Cizor",
      "id": 11782718,
      "node_id": "MDQ6VXNlcjExNzgyNzE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/11782718?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Cizor",
      "html_url": "https://github.com/Cizor",
      "followers_url": "https://api.github.com/users/Cizor/followers",
      "following_url": "https://api.github.com/users/Cizor/following{/other_user}",
      "gists_url": "https://api.github.com/users/Cizor/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Cizor/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Cizor/subscriptions",
      "organizations_url": "https://api.github.com/users/Cizor/orgs",
      "repos_url": "https://api.github.com/users/Cizor/repos",
      "events_url": "https://api.github.com/users/Cizor/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Cizor/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "labels": [
      {
        "id": 9737890014,
        "node_id": "LA_kwDOQfMfks8AAAACRGxo3g",
        "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/labels/type:feature",
        "name": "type:feature",
        "color": "942327",
        "default": false,
        "description": ""
      },
      {
        "id": 9782134341,
        "node_id": "LA_kwDOQfMfks8AAAACRw-GRQ",
        "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/labels/scope:4-sbi",
        "name": "scope:4-sbi",
        "color": "5a2e28",
        "default": false,
        "description": ""
      },
      {
        "id": 9782140626,
        "node_id": "LA_kwDOQfMfks8AAAACRw-e0g",
        "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/labels/chunk:9-sbi-integration",
        "name": "chunk:9-sbi-integration",
        "color": "b9eda4",
        "default": false,
        "description": ""
      }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
      "login": "Cizor",
      "id": 11782718,
      "node_id": "MDQ6VXNlcjExNzgyNzE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/11782718?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Cizor",
      "html_url": "https://github.com/Cizor",
      "followers_url": "https://api.github.com/users/Cizor/followers",
      "following_url": "https://api.github.com/users/Cizor/following{/other_user}",
      "gists_url": "https://api.github.com/users/Cizor/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Cizor/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Cizor/subscriptions",
      "organizations_url": "https://api.github.com/users/Cizor/orgs",
      "repos_url": "https://api.github.com/users/Cizor/repos",
      "events_url": "https://api.github.com/users/Cizor/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Cizor/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "assignees": [
      {
        "login": "Cizor",
        "id": 11782718,
        "node_id": "MDQ6VXNlcjExNzgyNzE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/11782718?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Cizor",
        "html_url": "https://github.com/Cizor",
        "followers_url": "https://api.github.com/users/Cizor/followers",
        "following_url": "https://api.github.com/users/Cizor/following{/other_user}",
        "gists_url": "https://api.github.com/users/Cizor/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/Cizor/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Cizor/subscriptions",
        "organizations_url": "https://api.github.com/users/Cizor/orgs",
        "repos_url": "https://api.github.com/users/Cizor/repos",
        "events_url": "https://api.github.com/users/Cizor/events{/privacy}",
        "received_events_url": "https://api.github.com/users/Cizor/received_events",
        "type": "User",
        "user_view_type": "public",
        "site_admin": false
      }
    ],
    "milestone": {
      "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/milestones/4",
      "html_url": "https://github.com/Cizor/spacetime-constellation-sim/milestone/4",
      "labels_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/milestones/4/labels",
      "id": 14244293,
      "node_id": "MI_kwDOQfMfks4A2VnF",
      "number": 4,
      "title": "Scope 4 – Planning & Scheduling",
      "description": "",
      "creator": {
        "login": "Cizor",
        "id": 11782718,
        "node_id": "MDQ6VXNlcjExNzgyNzE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/11782718?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Cizor",
        "html_url": "https://github.com/Cizor",
        "followers_url": "https://api.github.com/users/Cizor/followers",
        "following_url": "https://api.github.com/users/Cizor/following{/other_user}",
        "gists_url": "https://api.github.com/users/Cizor/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/Cizor/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Cizor/subscriptions",
        "organizations_url": "https://api.github.com/users/Cizor/orgs",
        "repos_url": "https://api.github.com/users/Cizor/repos",
        "events_url": "https://api.github.com/users/Cizor/events{/privacy}",
        "received_events_url": "https://api.github.com/users/Cizor/received_events",
        "type": "User",
        "user_view_type": "public",
        "site_admin": false
      },
      "open_issues": 73,
      "closed_issues": 0,
      "state": "open",
      "created_at": "2025-11-29T09:54:27Z",
      "updated_at": "2025-12-10T17:09:37Z",
      "due_on": null,
      "closed_at": null
    },
    "comments": 0,
    "created_at": "2025-12-09T19:23:18Z",
    "updated_at": "2025-12-09T19:23:18Z",
    "closed_at": null,
    "author_association": "OWNER",
    "active_lock_reason": null,
    "sub_issues_summary": {
      "total": 0,
      "completed": 0,
      "percent_completed": 0
    },
    "parent_issue_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/165",
    "issue_dependencies_summary": {
      "blocked_by": 0,
      "total_blocked_by": 0,
      "blocking": 0,
      "total_blocking": 0
    },
    "body": "## Background\n\nBy this point you have, in earlier Scope 4 chunks:\n\n- SBI domain and plumbing:\n  - `EventScheduler` interface + real/fake implementations (Chunk 3).\n  - `Agent` implementation with:\n    - Local schedule queue and execution.\n    - CDPI stream handling.\n    - Telemetry loop (Chunk 4, 6, 7).\n  - `CDPIServer` implementing `ControlDataPlaneInterface.ReceiveRequests` (Chunk 5).\n  - `TelemetryServer` + `TelemetryState` (Chunk 6).\n  - Controller-side `Scheduler` that:\n    - Inspects `ScenarioState`.\n    - Emits `ScheduledAction`s via CDPI (Chunk 8).\n\n- NBI-based scenario load path:\n  - A way to load/create `ScenarioState` from NBI / config.\n  - A time controller / sim clock driving Scope 1/2 dynamics.\n\nWhat’s missing in **Chunk 9** is wiring all of these SBI components into the **simulator startup** so that:\n\n- When you start a scenario:\n  - SBI servers (CDPI + Telemetry) are created and registered on the gRPC server.\n  - A controller `Scheduler` is instantiated and pointed at `ScenarioState` + `CDPIServer`.\n  - One `Agent` per node is created and started, connected back to CDPI as a client.\n- When the scenario ends or context is cancelled:\n  - Agents are stopped cleanly.\n  - SBI servers can shut down along with the main gRPC server.\n\nThis issue focuses on the **startup wiring** and lifecycle plumbing in the simulator process, without yet adding feature flags or advanced run-loop integration (those come in related Chunk 9 issues).\n\n## Goal\n\n- Extend the simulator’s **scenario startup flow** to:\n  - Construct and own all SBI components:\n    - `EventScheduler` (real implementation).\n    - `TelemetryState` + `TelemetryServer`.\n    - `CDPIServer`.\n    - Controller `Scheduler`.\n    - Per-node `Agent` instances.\n  - Register CDPI and Telemetry services on the gRPC server.\n  - Start agents so they connect to CDPI and begin participating in SBI.\n- Ensure there is a clear ownership / lifecycle:\n  - Where they are created.\n  - How they are wired together.\n  - How they are shut down on scenario stop or context cancel.\n- Keep the wiring **minimal but explicit**, making future refactors (flags, multiple scenarios, etc.) straightforward.\n\n## Where to look\n\nSimulator entrypoints / scenario orchestration:\n\n- CLI / main:\n  - `cmd/simulator/main.go` or equivalent.\n- Scenario runner:\n  - Something like `sim/runner`, `internal/sim/runner.go` or `internal/app/simulator.go`.\n  - Wherever you currently:\n    - Load a scenario via NBI or config.\n    - Build `ScenarioState`.\n    - Create the time controller.\n    - Start the sim run loop.\n\nExisting state and SBI components:\n\n- `ScenarioState`:\n  - Under `internal/sim/state` or `sim/state`.\n  - Where links, nodes, and interfaces are already managed.\n\n- SBI domain:\n  - `internal/sbi/agent`:\n    - `Agent` struct and constructor(s).\n  - `internal/sbi/controller`:\n    - `CDPIServer`.\n    - `Scheduler`.\n\n- Telemetry:\n  - `TelemetryState` and `TelemetryServer`:\n    - Likely under `internal/sbi/telemetry` or `sim/state/telemetry`.\n\ngRPC server wiring:\n\n- Wherever NBI services are registered:\n  - The existing call site for:\n    - `nbi.RegisterScenarioServiceServer(grpcServer, ...)`\n    - Other NBI services.\n- This is where you’ll also register:\n  - `scheduling.RegisterControlDataPlaneInterfaceServer(grpcServer, cdpiServer)`\n  - `telemetry.RegisterTelemetryServiceServer(grpcServer, telemetryServer)`\n\nSearch terms:\n\n- `ScenarioState`\n- `NewScenarioState` / `BuildScenarioState`\n- `grpc.NewServer`\n- `RegisterScenarioServiceServer`\n- `Agent` (under `internal/sbi/agent`)\n- `CDPIServer`\n- `Scheduler` (controller)\n\n## Tasks\n\n### 1. Introduce a SBI wiring helper / struct\n\nCreate a small package or helper that encapsulates SBI wiring, e.g.:\n\n- `internal/sbi/runtime` or similar:\n\n      type SBIRuntime struct {\n          State      *simstate.ScenarioState\n          Clock      sbi.EventScheduler\n          Telemetry  *TelemetryState\n          TelemetryS *TelemetryServer\n          CDPI       *CDPIServer\n          Scheduler  *Scheduler\n          Agents     []*agent.Agent\n\n          // Optional:\n          // shutdown hooks, waitgroups, logger, etc.\n      }\n\nAdd a constructor:\n\n- `func NewSBIRuntime(state *simstate.ScenarioState, clock sbi.EventScheduler, conn *grpc.ClientConn, logger Logger) (*SBIRuntime, error)`\n\n  - Parameters:\n    - `state`: the already-built `ScenarioState`.\n    - `clock`: real `EventScheduler` implementation bound to sim clock.\n    - `conn`: gRPC client connection that agents will use to reach CDPI/Telemetry (if in-process, you may have a special client factory; wire whatever you already use for NBI).\n    - `logger`: optional structured logger.\n\n- Responsibilities inside `NewSBIRuntime`:\n  - Create `TelemetryState` and `TelemetryServer`.\n  - Create `CDPIServer` with:\n    - `State` and `Clock`.\n  - Create controller `Scheduler` with:\n    - `State`, `Clock`, `CDPI`.\n  - Iterate over nodes in `ScenarioState` and:\n    - For each node that should have an agent, create an `Agent` configured with:\n      - `NodeID` and `AgentID`.\n      - Shared `ScenarioState`.\n      - Shared `EventScheduler`.\n      - Telemetry client stub.\n      - CDPI client stub (for the agent’s `ReceiveRequests` stream).\n      - Logger.\n    - Append each agent to `Agents`.\n\n> Design note: If your agents call CDPI over the same in-process gRPC server, you might have to:\n> - Start the server first.\n> - Dial a loopback client connection for agents (`grpc.DialContext(\"localhost:port\", ...)`).\n> This issue can treat that detail as “already available”, or document that it’s done at the caller site.\n\n### 2. Register SBI servers with the gRPC server\n\nIn the main simulator wiring (where you create your gRPC server):\n\n- After `grpc.NewServer()` and before `Serve`:\n\n  - Create or receive the `SBIRuntime`.\n  - Register SBI servers:\n\n        scheduling.RegisterControlDataPlaneInterfaceServer(grpcServer, sbiRuntime.CDPI)\n        telemetry.RegisterTelemetryServiceServer(grpcServer, sbiRuntime.TelemetryS)\n\n  - Keep the existing NBI server registrations unchanged.\n\n- Ensure `SBIRuntime` is reachable from the main run loop:\n  - Store it in a higher-level struct, e.g.:\n\n        type App struct {\n            GRPC      *grpc.Server\n            State     *simstate.ScenarioState\n            Clock     sbi.EventScheduler\n            SBIRuntime *sbi_runtime.SBIRuntime\n            // ...\n        }\n\n### 3. Start agents as part of scenario startup\n\nIn the scenario startup sequence (after building `ScenarioState`, `Clock`, and `SBIRuntime`):\n\n- Start agents:\n\n      func (r *SBIRuntime) StartAgents(ctx context.Context) error {\n          var wg sync.WaitGroup\n          var firstErr error\n          for _, ag := range r.Agents {\n              wg.Add(1)\n              go func(a *agent.Agent) {\n                  defer wg.Done()\n                  if err := a.Start(ctx); err != nil {\n                      // record/log error; for now, capture the first one\n                  }\n              }(ag)\n          }\n          // Optionally return early if you want async behavior,\n          // or wait for a first successful Hello/stream in each Agent.Start.\n          return firstErr\n      }\n\n- Call this from the main scenario runner:\n\n      // 1) Load scenario & build ScenarioState.\n      // 2) Create EventScheduler bound to sim time controller.\n      // 3) Create SBIRuntime (CDPI, Telemetry, Scheduler, Agents).\n      // 4) Register SBI services on the grpc.Server.\n      // 5) Start grpc.Server (if not already running).\n      // 6) Start agents with the scenario context.\n\n- Ensure that:\n  - Agents use a context tied to the scenario lifecycle (cancelled when scenario ends).\n  - Any errors in agent startup are logged and surfaced appropriately.\n\n### 4. Ensure clean shutdown of agents & SBI components\n\nAdd shutdown/cleanup methods on `SBIRuntime`, e.g.:\n\n- `func (r *SBIRuntime) StopAgents()`\n- `func (r *SBIRuntime) Close()`\n\nImplementation sketches:\n\n- `StopAgents`:\n  - If agents hold onto a context cancel function, call it.\n  - Or expose `Agent.Stop()` and call it for each agent.\n- `Close`:\n  - Stop agents.\n  - Optionally flush any outstanding scheduler state.\n  - Let the main app handle `grpcServer.GracefulStop()`.\n\nWire `SBIRuntime.Close()` into your simulator shutdown path:\n\n- On scenario completion or process termination:\n  - Cancel the main context.\n  - Call `SBIRuntime.Close()`.\n  - Stop the gRPC server.\n\n### 5. Minimal integration tests (optional but recommended for this issue)\n\nIf feasible within this issue (or as a follow-up test issue):\n\n- Add a basic integration test under `internal/sim` or `internal/sbi`:\n\n  - Construct:\n    - In-memory `ScenarioState` with a couple of nodes.\n    - Fake `EventScheduler`.\n    - In-process gRPC server.\n  - Wire up `SBIRuntime`.\n  - Start:\n    - gRPC server.\n    - Agents.\n  - Assert that:\n    - Agents connect to CDPI (Hello logged/observed).\n    - Telemetry / CDPI servers are registered and can be dialed.\n\n> If this is too heavy for the current issue, at least add TODOs / comments indicating where dedicated integration tests will live (likely under Chunk 11 “in-process gRPC SBI & Telemetry tests”).\n\n## Acceptance criteria\n\n- SBI runtime wiring:\n  - There is a clear `SBIRuntime` (or similar) construct that:\n    - Owns `TelemetryState` + `TelemetryServer`.\n    - Owns `CDPIServer`.\n    - Owns controller `Scheduler`.\n    - Owns a list of `Agent` instances.\n  - `SBIRuntime` is created during scenario startup with references to:\n    - `ScenarioState`.\n    - Real `EventScheduler`.\n    - gRPC client connection(s) needed for agents.\n\n- gRPC server registration:\n  - `ControlDataPlaneInterface` server (`CDPIServer`) is registered on the simulator’s gRPC server.\n  - `TelemetryService` server (`TelemetryServer`) is registered on the simulator’s gRPC server.\n  - Existing NBI server registration continues to work.\n\n- Agent lifecycle:\n  - On scenario startup:\n    - One `Agent` per relevant node is created and started.\n    - Agents use the shared `EventScheduler` and `ScenarioState`.\n    - Agents are able to connect to the in-process CDPI server via client stubs.\n  - On scenario shutdown:\n    - Agents are stopped cleanly (via context cancel or explicit `Stop()`).\n    - No goroutines are left hanging in steady-state tests.\n\n- Separation of concerns:\n  - Simulator entrypoint / runner is responsible for:\n    - Building `ScenarioState` and time controller.\n    - Creating and owning `SBIRuntime`.\n    - Registering services and starting the gRPC server.\n  - `SBIRuntime` is responsible for:\n    - Constructing SBI components.\n    - Starting and stopping agents.\n\n- Repository health:\n  - `go build ./...` passes after wiring changes.\n  - Existing unit tests continue to pass.\n  - Any new tests added for SBI wiring also pass.\n",
    "closed_by": null,
    "reactions": {
      "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/167/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/167/timeline",
    "performed_via_github_app": null,
    "state_reason": null
  },
  {
    "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/168",
    "repository_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim",
    "labels_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/168/labels{/name}",
    "comments_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/168/comments",
    "events_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/168/events",
    "html_url": "https://github.com/Cizor/spacetime-constellation-sim/issues/168",
    "id": 3712344639,
    "node_id": "I_kwDOQfMfks7dReI_",
    "number": 168,
    "title": "[Scope 4][Chunk 9] Implement simulation run loop & EventScheduler integration",
    "user": {
      "login": "Cizor",
      "id": 11782718,
      "node_id": "MDQ6VXNlcjExNzgyNzE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/11782718?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Cizor",
      "html_url": "https://github.com/Cizor",
      "followers_url": "https://api.github.com/users/Cizor/followers",
      "following_url": "https://api.github.com/users/Cizor/following{/other_user}",
      "gists_url": "https://api.github.com/users/Cizor/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Cizor/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Cizor/subscriptions",
      "organizations_url": "https://api.github.com/users/Cizor/orgs",
      "repos_url": "https://api.github.com/users/Cizor/repos",
      "events_url": "https://api.github.com/users/Cizor/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Cizor/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "labels": [
      {
        "id": 9737890014,
        "node_id": "LA_kwDOQfMfks8AAAACRGxo3g",
        "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/labels/type:feature",
        "name": "type:feature",
        "color": "942327",
        "default": false,
        "description": ""
      },
      {
        "id": 9782134341,
        "node_id": "LA_kwDOQfMfks8AAAACRw-GRQ",
        "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/labels/scope:4-sbi",
        "name": "scope:4-sbi",
        "color": "5a2e28",
        "default": false,
        "description": ""
      },
      {
        "id": 9782140626,
        "node_id": "LA_kwDOQfMfks8AAAACRw-e0g",
        "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/labels/chunk:9-sbi-integration",
        "name": "chunk:9-sbi-integration",
        "color": "b9eda4",
        "default": false,
        "description": ""
      }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
      "login": "Cizor",
      "id": 11782718,
      "node_id": "MDQ6VXNlcjExNzgyNzE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/11782718?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Cizor",
      "html_url": "https://github.com/Cizor",
      "followers_url": "https://api.github.com/users/Cizor/followers",
      "following_url": "https://api.github.com/users/Cizor/following{/other_user}",
      "gists_url": "https://api.github.com/users/Cizor/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Cizor/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Cizor/subscriptions",
      "organizations_url": "https://api.github.com/users/Cizor/orgs",
      "repos_url": "https://api.github.com/users/Cizor/repos",
      "events_url": "https://api.github.com/users/Cizor/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Cizor/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "assignees": [
      {
        "login": "Cizor",
        "id": 11782718,
        "node_id": "MDQ6VXNlcjExNzgyNzE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/11782718?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Cizor",
        "html_url": "https://github.com/Cizor",
        "followers_url": "https://api.github.com/users/Cizor/followers",
        "following_url": "https://api.github.com/users/Cizor/following{/other_user}",
        "gists_url": "https://api.github.com/users/Cizor/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/Cizor/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Cizor/subscriptions",
        "organizations_url": "https://api.github.com/users/Cizor/orgs",
        "repos_url": "https://api.github.com/users/Cizor/repos",
        "events_url": "https://api.github.com/users/Cizor/events{/privacy}",
        "received_events_url": "https://api.github.com/users/Cizor/received_events",
        "type": "User",
        "user_view_type": "public",
        "site_admin": false
      }
    ],
    "milestone": {
      "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/milestones/4",
      "html_url": "https://github.com/Cizor/spacetime-constellation-sim/milestone/4",
      "labels_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/milestones/4/labels",
      "id": 14244293,
      "node_id": "MI_kwDOQfMfks4A2VnF",
      "number": 4,
      "title": "Scope 4 – Planning & Scheduling",
      "description": "",
      "creator": {
        "login": "Cizor",
        "id": 11782718,
        "node_id": "MDQ6VXNlcjExNzgyNzE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/11782718?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Cizor",
        "html_url": "https://github.com/Cizor",
        "followers_url": "https://api.github.com/users/Cizor/followers",
        "following_url": "https://api.github.com/users/Cizor/following{/other_user}",
        "gists_url": "https://api.github.com/users/Cizor/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/Cizor/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Cizor/subscriptions",
        "organizations_url": "https://api.github.com/users/Cizor/orgs",
        "repos_url": "https://api.github.com/users/Cizor/repos",
        "events_url": "https://api.github.com/users/Cizor/events{/privacy}",
        "received_events_url": "https://api.github.com/users/Cizor/received_events",
        "type": "User",
        "user_view_type": "public",
        "site_admin": false
      },
      "open_issues": 73,
      "closed_issues": 0,
      "state": "open",
      "created_at": "2025-11-29T09:54:27Z",
      "updated_at": "2025-12-10T17:09:37Z",
      "due_on": null,
      "closed_at": null
    },
    "comments": 0,
    "created_at": "2025-12-09T19:28:59Z",
    "updated_at": "2025-12-09T19:28:59Z",
    "closed_at": null,
    "author_association": "OWNER",
    "active_lock_reason": null,
    "sub_issues_summary": {
      "total": 0,
      "completed": 0,
      "percent_completed": 0
    },
    "parent_issue_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/165",
    "issue_dependencies_summary": {
      "blocked_by": 0,
      "total_blocked_by": 0,
      "blocking": 0,
      "total_blocking": 0
    },
    "body": "## Background\n\nBy this point in **Scope 4** you have:\n\n- A working **ScenarioState**:\n  - Holds nodes, interfaces, links, service requests, etc.\n- A **real EventScheduler** implementation (Chunk 3):\n  - Backed by the simulation clock / time controller.\n  - Supports `Schedule`, `Cancel`, and `Now`.\n- A set of **Agents** (Chunk 4):\n  - Own local scheduled actions.\n  - Use `EventScheduler` to execute actions at the right sim time.\n  - Emit telemetry via TelemetryService.\n- A **Scheduler** on the controller side (Chunk 8):\n  - Generates `ScheduledAction`s for beams and routes.\n  - Sends them to agents via CDPI.\n- SBI plumbing (Chunks 5–7):\n  - CDPI server and agent streams.\n  - Telemetry service.\n  - Reset / Finalize / tokens semantics.\n\nWhat’s still missing for **Chunk 9** is a *single, coherent run loop* that:\n\n- Drives the **simulation clock** forward.\n- Ensures the **EventScheduler** runs due events at each step.\n- Coordinates:\n  - **Scenario startup** (loading a scenario and wiring SBI).\n  - **Scheduler execution** (when and how often to compute schedules).\n  - **Agent lifecycle** (start/stop tied to scenario lifecycle).\n\nRight now, you might have separate pieces that “can” be wired together, but no concrete, documented **run loop** that a developer can call (e.g. `RunScenario(ctx, cfg)`).\n\nThis issue focuses on the **core run loop integration**:\n- How sim time advances.\n- When EventScheduler events are executed.\n- Where controller Scheduler and agents are invoked.\n\nConfiguration flags (`--enable-sbi`, `--telemetry-interval`, etc.) are handled in a separate Chunk 9 issue.\n\n## Goal\n\nProvide a clear, testable **simulation run loop** that:\n\n- Drives the **sim clock** and **EventScheduler** together.\n- Starts and stops:\n  - CDPI server.\n  - Telemetry server.\n  - Controller Scheduler.\n  - Agents (one per node).\n- Provides a single entry point (or small API) to:\n  - Load a scenario.\n  - Wire SBI components.\n  - Run the simulation until:\n    - A specified sim-time horizon, or\n    - Context cancellation / shutdown.\n\n## Where to look\n\nScenario lifecycle & main entry:\n\n- Existing CLI / main entry points, e.g.:\n  - `cmd/simulator/main.go`\n  - Or a `sim/runner` package.\n- Where scenarios are currently:\n  - Loaded (via NBI or static config).\n  - Bound to `ScenarioState`.\n  - Driven by a time controller / timectrl package.\n\nTime controller & scheduler:\n\n- Time control module, e.g. `timectrl`:\n  - Provides:\n    - `Now()` equiv.\n    - `StepTo(t time.Time)` or a loop over time steps.\n- Event scheduler implementation (Chunk 3), e.g.:\n  - `internal/sbi/eventscheduler.go`\n  - Functions:\n    - `Schedule(at time.Time, f func()) (id string)`\n    - `Cancel(id string)`\n    - `Now() time.Time`\n    - Possibly `RunDue(now time.Time)` or similar.\n\nSBI components:\n\n- CDPI server (Chunk 5), e.g. `internal/sbi/controller/cdpi_server.go`.\n- Telemetry server (Chunk 6), e.g. `internal/sbi/telemetry_server.go`.\n- Controller Scheduler (Chunk 8), e.g. `internal/sbi/controller/scheduler.go`.\n- Agent code (Chunk 4), e.g. `internal/sbi/agent/agent.go`.\n\nSearch terms:\n\n- `ScenarioState`\n- `RunScenario`\n- `EventScheduler`\n- `timectrl`\n- `CDPIServer`\n- `TelemetryServer`\n- `Scheduler struct`\n- `Agent struct`\n\n## Tasks\n\n### 1. Define a central RunScenario API\n\nCreate a new package or file (if not already present), for example:\n\n- `internal/simrunner/runner.go` or\n- `sim/runner.go`\n\nDefine a struct to hold run-time wiring:\n\n- Example:\n\n      type ScenarioRunner struct {\n          State     *simstate.ScenarioState\n          Clock     timectrl.SimClock        // or equivalent interface\n          Scheduler sbi.EventScheduler       // real EventScheduler\n\n          CDPI      *sbi.CDPIServer\n          Telemetry *sbi.TelemetryServer\n          CtrlSched *sbi.Scheduler           // controller scheduling logic\n\n          Agents    []*sbi.Agent\n      }\n\nAdd a constructor or helper:\n\n- Example:\n\n      type RunnerConfig struct {\n          Scenario     *simstate.ScenarioState\n          Clock        timectrl.SimClock\n          Scheduler    sbi.EventScheduler\n          CDPIServer   *sbi.CDPIServer\n          TelemetrySrv *sbi.TelemetryServer\n          Controller   *sbi.Scheduler\n          Agents       []*sbi.Agent\n\n          EndTime      time.Time // sim-time horizon\n      }\n\n      func NewScenarioRunner(cfg RunnerConfig) *ScenarioRunner\n\nDesign notes:\n\n- `RunnerConfig` should be easy to build from `cmd/simulator`.\n- `EndTime` can be:\n  - A fixed horizon, or\n  - Zero-value to mean “run until context cancel”.\n\n### 2. Implement ScenarioRunner.Start / Stop\n\nAdd top-level methods:\n\n- `Start(ctx context.Context) error`\n- `Run(ctx context.Context) error` (or combine Start+Run)\n- `Stop()` / `Shutdown()` to cleanly stop agents and servers.\n\nSuggested flow in `Start`:\n\n1. Start Telemetry and CDPI gRPC servers (or assume they are already bound to a shared server; at minimum ensure they’re configured).\n2. Start each **Agent**:\n   - `for _, a := range r.Agents { go a.Start(ctx) }`\n3. Start the **controller Scheduler**, if it has a loop:\n   - Either:\n     - Provide a `CtrlSched.Start(ctx)` that runs in a goroutine, or\n     - Call a one-shot `CtrlSched.PrimeSchedule()` if you pre-compute schedules.\n4. Ensure **Clock** and **Scheduler** share the same notion of `Now()`.\n\n`Stop` should:\n\n- Cancel the context or call `Agent.Stop()` on each agent.\n- Stop any controller Scheduler loop if it has one.\n- Stop gRPC servers if they are owned here.\n\n### 3. Implement the main run loop (sim time + EventScheduler)\n\nAdd a method like:\n\n- `func (r *ScenarioRunner) RunUntil(ctx context.Context, endTime time.Time) error`\n\nCore logic:\n\n1. Determine initial time:\n\n       now := r.Clock.Now()\n\n2. Loop until end condition:\n\n       for {\n           // Check context cancellation first.\n           select {\n           case <-ctx.Done():\n               return ctx.Err()\n           default:\n           }\n\n           now = r.Clock.Now()\n           if !endTime.IsZero() && !now.Before(endTime) {\n               break\n           }\n\n           // 1) Run due EventScheduler events at this time.\n           r.Scheduler.RunDue(now) // or equivalent\n\n           // 2) Advance sim time:\n           //    - Either a fixed step, or\n           //    - To next scheduled event / connectivity event.\n           next := r.nextSimStep(now, endTime)\n           if next.IsZero() || !next.After(now) {\n               // Avoid infinite loop; choose a minimal step.\n               next = now.Add(time.Second)\n           }\n\n           // Advance time controller to `next`.\n           if err := r.Clock.StepTo(next); err != nil {\n               return err\n           }\n       }\n\n3. After loop, optionally do a final `RunDue(endTime)` to flush events.\n\n`nextSimStep` can be a helper:\n\n- For now, keep it simple:\n\n      func (r *ScenarioRunner) nextSimStep(now, endTime time.Time) time.Time {\n          // For Scope 4, a fixed delta (e.g. 1s or 10s) is fine.\n          step := 1 * time.Second\n          candidate := now.Add(step)\n          if !endTime.IsZero() && candidate.After(endTime) {\n              return endTime\n          }\n          return candidate\n      }\n\nDesign notes:\n\n- Future scopes might replace this with:\n  - “Jump to next event time” strategy.\n  - Integration with connectivity “in view” events.\n\n### 4. Ensure controller Scheduler hooks into the run loop\n\nIf your controller Scheduler has its own periodic loop:\n\n- For example, a method:\n\n      func (s *Scheduler) Tick(now time.Time)\n\nThen integrate it into the run loop:\n\n- Inside each loop iteration (or every N iterations):\n\n      r.CtrlSched.Tick(now)\n\nIf your Scheduler is event-driven or precomputes actions:\n\n- You might have:\n\n      func (s *Scheduler) PopulateInitialSchedule(horizon time.Time) error\n\nCall this once before the main loop:\n\n- In `Start` or before `RunUntil` begins.\n\nDesign notes:\n\n- For Scope 4, you can keep the Scheduler **simple**:\n  - Precompute a schedule up to `endTime`.\n  - Or run a `Tick` each loop to:\n    - Look at connectivity and service requests.\n    - Issue new CreateEntryRequests via CDPI as needed.\n\n### 5. Integrate with existing main / CLI\n\nWire `ScenarioRunner` into your existing entry point, e.g. `cmd/simulator/main.go`:\n\n1. Parse CLI flags (Scope 9 config handled in a separate issue).\n2. Build ScenarioState (load scenario via NBI or static config).\n3. Construct:\n   - SimClock / time controller.\n   - EventScheduler instance bound to sim clock.\n   - TelemetryState + TelemetryServer.\n   - CDPIServer.\n   - Controller Scheduler.\n   - Agents:\n     - One `Agent` per NetworkNode that should participate in SBI.\n4. Build `RunnerConfig` and `ScenarioRunner`.\n5. Call:\n\n       ctx, cancel := context.WithCancel(context.Background())\n       defer cancel()\n\n       if err := runner.Start(ctx); err != nil {\n           // log and exit\n       }\n\n       endTime := scenarioEndTimeFromConfigOrState(...)\n       if err := runner.RunUntil(ctx, endTime); err != nil {\n           // log and exit\n       }\n\n       runner.Stop()\n\nMake sure this path is:\n\n- The **default** when Scope 4 is enabled.\n- Trivially bypassed if someone runs a minimal core-only mode (Scope 1–3 only).\n\n### 6. Add unit tests for the run loop\n\nCreate a test file, e.g.:\n\n- `internal/simrunner/runner_test.go`\n\nUse fakes:\n\n- **FakeSimClock**:\n  - Stores current time.\n  - Implements `Now()` and `StepTo(t time.Time)`.\n- **FakeEventScheduler**:\n  - Records events.\n  - Provides `RunDue(now time.Time)` that:\n    - Runs any events scheduled at or before `now`.\n- **FakeScheduler (controller)**:\n  - Records calls to `Tick(now)` or `PopulateInitialSchedule`.\n- **FakeAgent**:\n  - Minimal struct implementing:\n    - `Start(ctx)` → record “started”.\n    - `Stop()` → record “stopped”.\n\nTest cases:\n\n1. Run loop advances sim time and runs scheduler events\n\n   - Given:\n     - Start time `T0`.\n     - End time `T0 + 3s`.\n     - A fake EventScheduler that:\n       - Has one event scheduled at `T0 + 2s`.\n   - When:\n     - `RunUntil(ctx, endTime)` is called.\n   - Assert:\n     - Sim clock `Now()` ends at or after `endTime`.\n     - Scheduled event was executed exactly once.\n     - Controller Scheduler’s `Tick` (if used) was called at least once.\n\n2. Agents are started and stopped\n\n   - Given:\n     - Runner with two fake agents.\n   - When:\n     - `Start(ctx)` then `RunUntil(ctx, endTime)` then `Stop()`.\n   - Assert:\n     - Each fake agent recorded `Start` and `Stop` calls.\n     - No panics or deadlocks.\n\n3. RunUntil respects context cancellation\n\n   - Given:\n     - A context that is cancelled mid-run.\n   - When:\n     - `RunUntil(ctx, endTime)` is running.\n   - Then:\n     - It exits with `context.Canceled` (or similar).\n     - No further EventScheduler `RunDue` calls occur after cancel.\n\n4. EndTime = zero means “run until cancel”\n\n   - Given:\n     - `endTime` is zero-value.\n   - When:\n     - You run `RunUntil(ctx, time.Time{})` and cancel context after some iterations.\n   - Assert:\n     - Run loop exits only when context is cancelled.\n\n## Acceptance criteria\n\n- **ScenarioRunner API**:\n  - A `ScenarioRunner` (or equivalent) type exists with:\n    - Fields tying together:\n      - `ScenarioState`\n      - `SimClock`\n      - `EventScheduler`\n      - `CDPIServer`\n      - `TelemetryServer`\n      - Controller `Scheduler`\n      - Agents slice\n    - A constructor or helper to build it from a `RunnerConfig`.\n\n- **Lifecycle methods**:\n  - `Start(ctx)`:\n    - Starts agents.\n    - Wires controller Scheduler (precompute or loop).\n    - Ensures SBI services are ready.\n  - `RunUntil(ctx, endTime)`:\n    - Advances simulation time via the sim clock.\n    - Calls `EventScheduler.RunDue` (or equivalent) at each step.\n    - Integrates controller Scheduler (`Tick` or precomputed schedule).\n    - Respects context cancellation and `endTime`.\n  - `Stop()`:\n    - Stops agents and any controller Scheduler loop.\n    - Cleanly shuts down any owned servers (if applicable).\n\n- **Integration with main / CLI**:\n  - `cmd/simulator` (or equivalent) uses `ScenarioRunner` when Scope 4 is enabled.\n  - A developer can:\n    - Load a scenario.\n    - Run the sim to a specified sim-time horizon.\n    - Observe agents, scheduler, and telemetry all active.\n\n- **Unit tests**:\n  - Cover:\n    - Sim time advancement and EventScheduler integration.\n    - Agents starting and stopping via runner lifecycle.\n    - Respecting context cancellation.\n    - Behavior when `endTime` is zero vs non-zero.\n  - All tests pass via `go test ./...`.\n\n- **Repository health**:\n  - `go build ./...` passes with the new runner code.\n  - No cycles introduced between packages (e.g. `simrunner` vs `sbi` vs `simstate`).\n",
    "closed_by": null,
    "reactions": {
      "url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/168/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/Cizor/spacetime-constellation-sim/issues/168/timeline",
    "performed_via_github_app": null,
    "state_reason": null
  }
]
