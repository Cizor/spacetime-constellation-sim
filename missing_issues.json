[
  {
    "title": "[Scope 4][Chunk 10] Add agent schedule execution unit tests",
    "body": "## Background\n\nChunk 10 requires unit tests for agent behavior. While scheduler and telemetry tests exist (#171, #172, #175), we need explicit tests for agent schedule execution - verifying that agents correctly receive, schedule, and execute actions.\n\n## Goal\n\nAdd comprehensive unit tests for agent schedule execution covering:\n- CreateEntry → scheduled execution → Response flow\n- DeleteEntry cancellation\n- FinalizeRequest cleanup\n\n## Tasks\n\n### 1. Set up test infrastructure\n\nIn `internal/sbi/agent/agent_test.go`:\n\n- Create `FakeEventScheduler` (or reuse from Chunk 3 tests)\n- Create `FakeScenarioState` that records method calls:\n  - `ApplyBeamUpdate` calls\n  - `ApplyBeamDelete` calls\n  - `InstallRoute` calls\n  - `RemoveRoute` calls\n- Create `FakeCDPIStream` that records `Response` messages sent\n\n### 2. Test CreateEntry → scheduled execution\n\nTest case:\n\n```go\nfunc TestAgent_CreateEntry_SchedulesAndExecutes(t *testing.T) {\n    // Setup: agent with fake scheduler, state, stream\n    // Action: simulate receiving CreateEntryRequest with:\n    //   - UpdateBeam at time T\n    //   - RequestID = \"req-123\"\n    // Verify:\n    //   - Action scheduled in EventScheduler\n    //   - Advance clock to T\n    //   - Assert ApplyBeamUpdate called with correct params\n    //   - Assert Response sent with matching request_id and OK status\n}\n```\n\nTest variations:\n- `ScheduledSetRoute` → `InstallRoute` called\n- `ScheduledDeleteRoute` → `RemoveRoute` called\n- `ScheduledDeleteBeam` → `ApplyBeamDelete` called\n\n### 3. Test DeleteEntry cancels scheduled event\n\nTest case:\n\n```go\nfunc TestAgent_DeleteEntry_CancelsScheduledAction(t *testing.T) {\n    // Setup: agent with scheduled action at time T\n    // Action: simulate DeleteEntryRequest for that EntryID\n    // Verify:\n    //   - Action removed from pending map\n    //   - EventScheduler.Cancel called\n    //   - Advance clock to T\n    //   - Assert NO beam/route helpers called\n}\n```\n\n### 4. Test FinalizeRequest cleanup\n\nTest case:\n\n```go\nfunc TestAgent_FinalizeRequest_DropsOldEntries(t *testing.T) {\n    // Setup: agent with two scheduled actions:\n    //   - Entry1 at T1 (before cutoff)\n    //   - Entry2 at T2 (after cutoff)\n    // Action: simulate FinalizeRequest with cutoff between T1 and T2\n    // Verify:\n    //   - Entry1 removed from pending\n    //   - Entry2 remains in pending\n    //   - Only Entry2 executes when clock reaches T2\n}\n```\n\n### 5. Test error handling\n\n- Invalid action type → appropriate error\n- Missing required fields → error handling\n- Token mismatch → log and ignore (per Chunk 7)\n\n## Acceptance Criteria\n\n- Unit tests exist for:\n  - CreateEntry → execution → Response flow\n  - DeleteEntry cancellation\n  - FinalizeRequest cleanup\n- All tests use fake dependencies (no real gRPC, no real time)\n- Tests are deterministic and fast\n- Coverage includes all ScheduledAction types (UpdateBeam, DeleteBeam, SetRoute, DeleteRoute)\n- `go test ./internal/sbi/agent/...` passes\n\n## Related Issues\n\n- Part of Chunk 10 epic (#170)\n- Depends on Chunk 4 agent implementation (#135-139)\n- Uses FakeEventScheduler from Chunk 3 (#134)",
    "labels": ["scope:4-sbi", "chunk:10-scope4-tests", "type:test"]
  },
  {
    "title": "[Scope 4][Chunk 12] Add DumpAgentState developer helper function",
    "body": "## Background\n\nChunk 12 requires a developer helper function for debugging agent state. This allows developers to inspect agent state during development and debugging without needing to add breakpoints or log statements.\n\n## Goal\n\nImplement a `DumpAgentState` function that returns a human-readable string representation of an agent's current state, including pending scheduled actions and telemetry metrics.\n\n## Tasks\n\n### 1. Define DumpAgentState function\n\nIn `internal/sbi/agent/agent.go` or `internal/sbi/agent/debug.go`:\n\n```go\n// DumpAgentState returns a human-readable string representation of the\n// agent's current state for debugging purposes.\nfunc (a *Agent) DumpAgentState() string {\n    a.mu.Lock()\n    defer a.mu.Unlock()\n    \n    var buf strings.Builder\n    buf.WriteString(fmt.Sprintf(\"Agent: %s (NodeID: %s)\\n\", a.AgentID, a.NodeID))\n    buf.WriteString(fmt.Sprintf(\"Token: %s\\n\", a.token))\n    buf.WriteString(fmt.Sprintf(\"Pending Actions: %d\\n\", len(a.pending)))\n    \n    // List pending actions\n    for entryID, action := range a.pending {\n        buf.WriteString(fmt.Sprintf(\"  - %s: %s at %s\\n\", \n            entryID, action.Type, action.When))\n    }\n    \n    return buf.String()\n}\n```\n\n### 2. Integrate with TelemetryState\n\nIf TelemetryState is accessible, include last telemetry metrics:\n\n```go\nfunc (a *Agent) DumpAgentState(telemetry *TelemetryState) string {\n    // ... agent state ...\n    \n    // Add telemetry metrics if available\n    if telemetry != nil {\n        metrics := telemetry.GetMetrics(a.NodeID, \"\")\n        if metrics != nil {\n            buf.WriteString(\"\\nLast Telemetry:\\n\")\n            buf.WriteString(fmt.Sprintf(\"  BytesTx: %d\\n\", metrics.BytesTx))\n            buf.WriteString(fmt.Sprintf(\"  Up: %v\\n\", metrics.Up))\n        }\n    }\n    \n    return buf.String()\n}\n```\n\n### 3. Add CDPI server helper\n\nIn `internal/sbi/controller/cdpi_server.go`:\n\n```go\n// DumpAgentState returns debug info for a specific agent.\nfunc (s *CDPIServer) DumpAgentState(agentID string) (string, error) {\n    s.agentsMu.RLock()\n    defer s.agentsMu.RUnlock()\n    \n    handle, ok := s.agents[agentID]\n    if !ok {\n        return \"\", fmt.Errorf(\"agent %s not found\", agentID)\n    }\n    \n    // If agent is accessible, call its DumpAgentState\n    // Otherwise return handle info\n    return fmt.Sprintf(\"AgentHandle: %s, NodeID: %s, Token: %s\", \n        handle.AgentID, handle.NodeID, handle.token), nil\n}\n```\n\n### 4. Add tests\n\nIn `internal/sbi/agent/agent_test.go`:\n\n```go\nfunc TestAgent_DumpAgentState(t *testing.T) {\n    agent := NewAgent(...)\n    agent.pending[\"entry1\"] = &ScheduledAction{...}\n    \n    dump := agent.DumpAgentState()\n    assert.Contains(t, dump, \"Agent:\")\n    assert.Contains(t, dump, \"entry1\")\n    assert.Contains(t, dump, \"Pending Actions: 1\")\n}\n```\n\n### 5. Optional: Add CLI command or debug endpoint\n\nConsider adding:\n- A debug flag to `cmd/nbi-server` that dumps all agent states\n- Or a debug gRPC method (if not exposing via NBI yet)\n\n## Acceptance Criteria\n\n- `DumpAgentState()` function exists on Agent\n- Returns formatted string with:\n  - AgentID, NodeID\n  - Current token\n  - List of pending scheduled actions (entryID, type, when)\n  - Optional: last telemetry metrics\n- CDPI server has helper to dump agent state\n- Unit tests verify output format\n- Function is thread-safe (uses agent's mutex)\n- `go test ./internal/sbi/agent/...` passes\n\n## Related Issues\n\n- Part of Chunk 12 epic (#178)\n- Complements logging (#179, #180) and metrics (#181, #182)\n- Useful for debugging Chunk 4 agent behavior",
    "labels": ["scope:4-sbi", "chunk:12-scope4-observability", "type:feature"]
  }
]




